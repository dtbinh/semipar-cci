```{r}
require('igraph')
require('ggplot2')
require('reshape')
require('gridExtra')


setwd("~/git/ABadea/")

listGs<- list.files(path = "./graphml/", pattern = "*.graphml")

#read in covariates and graph list
#find those with common ids, sort by id

covariates<- read.csv("./covariates/predictors.csv",stringsAsFactors = F)
ids <- unlist( lapply(listGs,function(x)strtrim(x,6)))
common_id<- intersect(covariates$RUNNO , ids)

covariates <- covariates[covariates$RUNNO%in%common_id,]
covariates <- covariates[order(covariates$RUNNO),]  

listGs<- listGs[ids%in%common_id]
listGs<- listGs[order(listGs)]

#load and sort the tensor decomp data
load("./tensorDecompBinary.Rda")
load("./listData.Rda")
ids2 <- unlist( lapply(dataList,function(x)strtrim(x$id,6)))
diagC<- tensorDecomp$C[ids2%in% common_id,]
diagC<- diagC[order(ids2[ids2%in% common_id]),]



graphList<- lapply(listGs, function(x){
  read.graph( file = paste("./graphml/",x,sep = ""),format = "graphml")
})

AdjacencyList<- lapply(graphList, function(x){
  get.adjacency(x)
})

HemisphereList<- lapply(graphList, function(x){
  get.vertex.attribute(x,name="hemisphere")
})

```


```{r}

colnames(AdjacencyList[[1]])

order_by_hemi<- order(HemisphereList[[1]])


AbyHemiSphere<- (as.matrix(AdjacencyList[[1]]))[order_by_hemi,order_by_hemi]

plotHeatmap<-function(denseA, zlimMax=1){
  rownames(denseA) <- c(1:nrow(denseA))
  colnames(denseA) <- c(1:nrow(denseA))
  m<-melt(denseA)
  n<- nrow(denseA)
  p <- ggplot(m, aes(X1, X2)) +
    geom_tile(aes(fill =  value), colour = "white") + 
    scale_fill_gradient(low = "white",  high = "red",limits=c(0,zlimMax)) +
    theme(axis.ticks = element_blank(), axis.text.x = element_blank(),axis.text.y = element_blank()) 
  
  p
}

```

# Adjacency Matrix

### One random subject:
The adjacency matrix of the whole brain. 

Segments:
Bottom left: *Left Hemisphere*
Upper right: *Right Hemisphere*

```{r}
wholeBrain<- plotHeatmap(AbyHemiSphere)
wholeBrain+ geom_hline(yintercept = nrow(AbyHemiSphere)/2 ) + geom_vline(xintercept = nrow(AbyHemiSphere)/2 )
```


### On average:
The adjacency matrix of the whole brain. 

Segments:
Bottom left: *Left Hemisphere*
Upper right: *Right Hemisphere*


```{r}

m<- length(AdjacencyList)


n<- nrow(AdjacencyList[[1]])

computeAvgA<- function(l){
  sumAdj<- matrix(0,n,n)
  for(i in 1:length(l)){
  sumAdj<- sumAdj + (AdjacencyList[[i]])[order_by_hemi,order_by_hemi]
  }
  as.matrix(sumAdj/m)
}

averageAdjacency<- computeAvgA(AdjacencyList)


avgWholeBrain<- plotHeatmap(averageAdjacency)
avgWholeBrain+ geom_hline(yintercept = nrow(AbyHemiSphere)/2 ) + geom_vline(xintercept = nrow(AbyHemiSphere)/2 )
```

##Now we focus on the average graph:

```{r}

lDegree<- rowSums(averageAdjacency[1:(n/2),1:(n/2)])
rDegree<- rowSums(averageAdjacency[(n/2+1):(n),(n/2+1):(n)])

df<- data.frame("ROI_Index"= rep(c(1:(n/2)),2),
                "Hemisphere"=as.factor(rep(c("L","R"),each=n/2)),
                "Degree" = c(lDegree,rDegree)
)

```

Degree plot by ROI index

```{r}
ggplot(data=df,
       aes(x=ROI_Index, y=Degree, colour=Hemisphere)) +
  geom_line()
```

Degree distribution
```{r}
ggplot(df, aes(x=Degree, fill=Hemisphere)) + geom_density(alpha = 0.7, bw = 3)
```


#Compare age related degeneration

plot of the age (in weeks)
```{r}
weeks<- covariates$AGE_WEEKS
plot(weeks)

quantile(weeks,c(0.25,0.75))
```

so we use <63 as the cut-off for young mice, >78.0 for old mice

```{r}

youngAvgA <- computeAvgA(AdjacencyList[weeks<=63])
middleageAvgA <- computeAvgA(AdjacencyList[weeks>63 & weeks<= 78  ])
oldAvgA <- computeAvgA(AdjacencyList[weeks>78])

zlim<- max(c(youngAvgA, middleageAvgA, oldAvgA))

youngAvgWholeBrain<- plotHeatmap(youngAvgA,zlimMax = zlim)+ geom_hline(yintercept = n/2 ) + geom_vline(xintercept =  n/2 )+
  ggtitle("Young")

middleageAvgWholeBrain<- plotHeatmap(middleageAvgA,zlimMax = zlim)+ geom_hline(yintercept = n/2 ) + geom_vline(xintercept =  n/2 )+
  ggtitle("Middle")

oldAvgWholeBrain<- plotHeatmap(oldAvgA,zlimMax = zlim) + geom_hline(yintercept = n/2 ) + geom_vline(xintercept =  n/2 )+
  ggtitle("old") 

```

Young:
```{r}
sum(weeks<=63)
youngAvgWholeBrain
```

Middle:
```{r}
sum(weeks>63 & weeks<= 78)

middleageAvgWholeBrain

```

Old:
```{r}
sum(weeks> 78)
oldAvgWholeBrain
```

#Degree distribution of the 3 age groups:
###Young mice have higher level of connectivy  (degree) than the middle and old.

```{r}

df<- data.frame("ROI_Index"= rep(c(1:(n/2)),3),
                "Age"=as.factor(rep(c("Young","Middle","Old"),each=n/2)),
                "Degree" = c(rowSums(youngAvgA),rowSums(middleageAvgA),rowSums(oldAvgA))
)

ggplot(df, aes(x=Degree, fill=Age)) + geom_density(alpha = 0.7, bw = 3)

```


#After dimension reduction:

Pairs plot of the first 5 dimensions:
```{r}

require('GGally')

ageGroup<-  (weeks<=63)*1 + (weeks>63 & weeks<=78)*2+(weeks>78)*3
ageGroup[ageGroup==1] = "Young"
ageGroup[ageGroup==2] = "Middle"
ageGroup[ageGroup==3] = "Old"

df<- data.frame("Latent Dimension Idx"= rep(c(1:30),m),
                "Age"=as.factor(rep(ageGroup,each=30)),
                "Latent Coordinate" = c(t(diagC))
)



K<- 5

seleDf<- diagC[,1:K]


# seleDf<- cbind((seleDf))

colnames(seleDf)<- c(  sapply(c(1:K),function(x){paste("x",x,sep = ".")}))

newDf<- as.data.frame(seleDf)
newDf<- cbind(newDf, ageGroup)
ggpairs(newDf,aes(col=ageGroup,alpha=0.4, binwidth=1))


```

Average scree plots of the 3 groups:
```{r}

C1<- diagC[ageGroup=="Young",]
C2<- diagC[ageGroup=="Middle",]
C3<- diagC[ageGroup=="Old",]

df<- data.frame("Latent.Dim"= rep(c(1:(30)),3),
                "AgeGroup"=as.factor(rep(c("Young","Middle","Old"),each=30)),
                "Latent.Coor" = c(colMeans(C1),colMeans(C2),colMeans(C3))
)

ggplot(data=df,
       aes(x=Latent.Dim, y=Latent.Coor, colour=AgeGroup)) +
  geom_line()

```

From the low dimension representation, old group looks obviously distinct from the middle and young groups.